import argparse
import json
import os
import pendulum
from retrying import retry
import requests
from notion_helper import NotionHelper
import utils
from dotenv import load_dotenv
from datetime import datetime

load_dotenv()
DOUBAN_API_HOST = os.getenv("DOUBAN_API_HOST", "frodo.douban.com")
DOUBAN_API_KEY = os.getenv("DOUBAN_API_KEY", "0ac44ae016490db2204ce0a042db2916")

DATE_EMOJ_ICON = "üóìÔ∏è"

from config import (
    movie_properties_type_dict,
    book_properties_type_dict,
    TAG_ICON_URL,
)
from utils import get_icon

headers = {
    "host": "api.xiaoyuzhoufm.com",
    "applicationid": "app.podcast.cosmos",
    "x-jike-refresh-token": os.getenv("REFRESH_TOKEN"),
    "x-jike-device-id": "5070e349-ba04-4c7b-a32e-13eb0fed01e7",
}


@retry(stop_max_attempt_number=3, wait_fixed=5000)
def refresh_token():
    url = "https://api.xiaoyuzhoufm.com/app_auth_tokens.refresh"
    print(headers)
    resp = requests.post(url, headers=headers)
    if resp.ok:
        token = resp.json().get("x-jike-access-token")
        headers["x-jike-access-token"] = token
    print(headers)


@retry(stop_max_attempt_number=3, wait_fixed=5000)
def get_podcast():
    results = []
    url = "https://api.xiaoyuzhoufm.com/v1/subscription/list"
    data = {
        "limit": 25,
        "sortBy": "subscribedAt",
        "sortOrder": "desc",
    }
    loadMoreKey = ""
    while loadMoreKey is not None:
        if loadMoreKey:
            data["loadMoreKey"] = loadMoreKey
        resp = requests.post(url, json=data, headers=headers)
        if resp.ok:
            loadMoreKey = resp.json().get("loadMoreKey")
            results.extend(resp.json().get("data"))
        else:
            refresh_token()
            raise Exception(f"Error {data} {resp.text}")
    return results


@retry(stop_max_attempt_number=3, wait_fixed=5000)
def get_mileage():
    results = []
    url = "https://api.xiaoyuzhoufm.com/v1/mileage/list"
    data = {"rank": "TOTAL"}
    loadMoreKey = ""
    while loadMoreKey is not None:
        if loadMoreKey:
            data["loadMoreKey"] = loadMoreKey
        resp = requests.post(url, json=data, headers=headers)
        if resp.ok:
            loadMoreKey = resp.json().get("loadMoreKey")
            for item in resp.json().get("data"):
                podcast = item.get("podcast")
                podcast["playedSeconds"] = item.get("playedSeconds", 0)
                results.append(podcast)
        else:
            refresh_token()
            raise Exception(f"Error {data} {resp.text}")
    return results


@retry(stop_max_attempt_number=3, wait_fixed=5000)
def get_episode(pid, timestamp):
    results = []
    url = "https://api.xiaoyuzhoufm.com/v1/episode/list"
    data = {
        "limit": 25,
        "pid": pid,
    }
    loadMoreKey = ""
    while loadMoreKey is not None:
        if loadMoreKey:
            data["loadMoreKey"] = loadMoreKey
        resp = requests.post(url, json=data, headers=headers)
        if resp.ok:
            loadMoreKey = resp.json().get("loadMoreKey")
            d = resp.json().get("data")
            for item in d:
                pubDate = pendulum.parse(item.get("pubDate")).in_tz("UTC").int_timestamp
                if pubDate <= timestamp:
                    return results
                item["pubDate"] = pubDate
                results.append(item)
        else:
            refresh_token()
            raise Exception(f"Error {data} {resp.text}")
    return results


@retry(stop_max_attempt_number=3, wait_fixed=5000)
def get_ep_progress(episode):
    results = []
    url = "https://api.xiaoyuzhoufm.com/v1/playback-progress/list"

    data = {
        "eids": [episode["BookId"]]
    }
    resp = requests.post(url, json=data, headers=headers)
    if resp.ok:
        d = resp.json().get("data")
        playAt = d[0]["playedAt"];
        playAtBeijingTime = pendulum.parse(playAt).in_tz('Asia/Shanghai')
        playAtDay = playAtBeijingTime.format("YYYY-MM-DD")
        episode["ÈòÖËØªÊó•"] = [playAtDay]
        episode["ÈòÖËØªÊó∂Èïø"] = d[0]["progress"]
    else:
        raise Exception(f"Error {data} {resp.text}")

def get_progress(eids):
    """Ëé∑ÂèñÊí≠ÊîæËøõÂ∫¶"""
    url = "https://api.xiaoyuzhoufm.com/v1/playback-progress/list"
    data = {"eids": eids}
    resp = requests.post(url, json=data, headers=headers)
    if resp.ok:
        return resp.json().get("data")

@retry(stop_max_attempt_number=3, wait_fixed=5000)
def get_history():
    results = []
    url = "https://api.xiaoyuzhoufm.com/v1/episode-played/list-history"
    data = {
        "limit": 25,
    }
    loadMoreKey = ""
    while loadMoreKey is not None:
        print("get history....")
        if loadMoreKey:
            data["loadMoreKey"] = loadMoreKey
        resp = requests.post(url, json=data, headers=headers)
        if resp.ok:
            loadMoreKey = resp.json().get("loadMoreKey")
            d = resp.json().get("data")
            for item in d:
                episode = item.get("episode")
                pubDate = pendulum.parse(episode.get("pubDate")).in_tz("UTC").int_timestamp
                episode["pubDate"] = pubDate
                results.append(episode)
        else:
            refresh_token()
            raise Exception(f"Error {data} {resp.text}")
    return results


def check_podcast(pid):
    """Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊèíÂÖ•Ëøá"""
    filter = {"property": "Pid", "rich_text": {"equals": pid}}
    response = notion_helper.query(
        database_id=notion_helper.podcast_database_id, filter=filter
    )
    if len(response["results"]) > 0:
        return response["results"][0].get("id")


def check_eposide(eid):
    """Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊèíÂÖ•Ëøá"""
    filter = {"property": "BookId", "rich_text": {"equals": eid}}
    response = notion_helper.query(
        database_id=notion_helper.episode_database_id, filter=filter
    )
    if len(response["results"]) > 0:
        return response["results"][0]


def get_timestamp(id):
    """Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊèíÂÖ•Ëøá"""
    filter = {"property": "Podcast", "relation": {"contains": id}}
    sorts = [
        {
            "property": "Êó∂Èó¥Êà≥",
            "direction": "descending",
        }
    ]
    response = notion_helper.query(
        database_id=notion_helper.episode_database_id,
        filter=filter,
        sorts=sorts,
        page_size=1,
    )
    if len(response["results"]) > 0:
        return response["results"][0].get("properties").get("Êó∂Èó¥Êà≥").get("number")
    return 0


def delete():
    """Âà†Èô§Êú™Âê¨ÁöÑ"""
    filter = {"property": "ÈòÖËØªÁä∂ÊÄÅ", "status": {"equals": "ÊÉ≥ËØª"}}
    results = notion_helper.query_all(
        database_id=notion_helper.episode_database_id, filter=filter
    )
    for index,result in enumerate(results):
        print(f"Ê≠£Âú®Âà†Èô§Á¨¨{index+1}‰∏™ÔºåÂÖ±{len(results)}‰∏™")
        notion_helper.delete_block(block_id=result.get("id"))


def merge_podcast(list1, list2):
    results = []
    results.extend(list1)
    d = {x.get("pid"): x for x in list1}
    for item in list2:
        if item.get("pid") not in d:
            results.append(item)
    return results


def insert_podcast():
    list1 = get_mileage()
    list2 = get_podcast()
    results = merge_podcast(list1, list2)
    dict = {}
    for index, result in enumerate(results):
        podcast = {}
        podcast["Êí≠ÂÆ¢"] = result.get("title")
        podcast["Brief"] = result.get("brief")
        pid = result.get("pid")
        podcast["Pid"] = pid
        podcast["Êî∂Âê¨Êó∂Èïø"] = result.get("playedSeconds", 0)
        podcast["Description"] = result.get("description")
        podcast["ÈìæÊé•"] = f"https://www.xiaoyuzhoufm.com/podcast/{result.get('pid')}"
        if result.get("latestEpisodePubDate"):
            podcast["ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥"] = (
                pendulum.parse(result.get("latestEpisodePubDate"))
                .in_tz("UTC")
                .int_timestamp
            )
        cover = result.get("image").get("picUrl")
        podcast["ÂÖ®ÈÉ®"] = [
            notion_helper.get_relation_id(
                "ÂÖ®ÈÉ®", notion_helper.all_database_id, TAG_ICON_URL
            )
        ]
        podcast["‰ΩúËÄÖ"] = [
            notion_helper.get_relation_id(
                x.get("nickname"),
                notion_helper.author_database_id,
                x.get("avatar").get("picture").get("picUrl"),
            )
            for x in result.get("podcasters")
        ]
        properties = utils.get_properties(podcast, movie_properties_type_dict)
        parent = {
            "database_id": notion_helper.podcast_database_id,
            "type": "database_id",
        }
        print(
            f"Ê≠£Âú®ÂêåÊ≠• = {result.get('title')}ÔºåÂÖ±{len(results)}‰∏™Êí≠ÂÆ¢ÔºåÂΩìÂâçÊòØÁ¨¨{index+1}‰∏™"
        )

        #if index >= 1:
        #   break
        
        page_id = check_podcast(pid)
        if page_id:
            notion_helper.update_page(page_id=page_id, properties=properties)
        else:
            page_id = notion_helper.create_page(
                parent=parent, properties=properties, icon=get_icon(cover)
            ).get("id")
        dict[pid] =(page_id, cover)
    return dict


def insert_episode(episodes, d):
    episodes.sort(key=lambda x: x["pubDate"])
    for index, result in enumerate(episodes):
        pid = result.get("pid")
        if pid not in d:
            continue
        episode = {}
        episode["Ê†áÈ¢ò"] = result.get("title")
        #episode["ÁÆÄ‰ªã"] = result.get("description")
        #episode["Êó∂Èó¥Êà≥"] = result.get("pubDate")
        episode["ÂèëÂ∏ÉÊó∂Èó¥"] = result.get("pubDate")
        episode["Èü≥È¢ë"] = result.get("media").get("source").get("url")
        eid = result.get("eid")
        episode["BookId"] = eid

        episode["Êó∂Èïø"] = result.get("duration")
        #episode["ÂñúÊ¨¢"] = result.get("isPicked")
        episode["Podcast"] = [d.get(pid)[0]]
        episode["ÈìæÊé•"] = f"https://www.xiaoyuzhoufm.com/episode/{result.get('eid')}"
        status = "Êú™Âê¨"
        if result.get("isFinished"):
            status = "ÈòÖËØªÂÆå"
        elif result.get("isPlayed"):
            status = "Âú®ËØª"
        episode["ÈòÖËØªÁä∂ÊÄÅ"] = status
        episode["Á±ªÂûã"] = "Êí≠ÂÆ¢"

        episode["ÈòÖËØªÊó∂Èïø"] = result.get("ÈòÖËØªÊó∂Èïø")
        episode["ÈòÖËØªÊó•"] = result.get("ÈòÖËØªÊó•")

        episode["ÈòÖËØªËøõÂ∫¶"] = 1 if (status == "ÂÆåÊàê") else episode["ÈòÖËØªÊó∂Èïø"] / episode["Êó∂Èïø"]

        episode['ÈòÖËØªÊó•'] = [
            notion_helper.get_relation_id_by_property("„ÄêÂÖºÂÆπ„ÄëÊó•Êúü", x, "date", notion_helper.day_database_id, DATE_EMOJ_ICON)
            for x in episode['ÈòÖËØªÊó•']
        ]

        print("Â§ÑÁêÜÂΩìÂâçÂçöÂÆ¢Ôºö" + json.dumps(episode))

        if (delta_listen_time < 60 * 10): #Êú¨Ê¨°Êî∂Âê¨Êó∂ÈïøÂ∞è‰∫é10ÂàÜÈíüÔºå‰∏çÂêåÊ≠•
            print(f"{result.get('title')}, Êú¨Ê¨°Êî∂Âê¨Êó∂Èïø{delta_listen_time}ÁßíÔºå‰∏çÂêåÊ≠•„ÄÇÂÖ±{len(episodes)}‰∏™EpisodeÔºåÂΩìÂâçÊòØÁ¨¨{index+1}‰∏™")
            continue

        delta_listen_time = int(episode['ÈòÖËØªÊó∂Èïø'])
        page = check_eposide(eid)
        if page:
            #Ëã•notion‰∏≠Â≠òÂú®ÂΩìÂâçepÔºåÂàôËøõË°åÂ±ûÊÄßÂêàÂπ∂
            oldReadDays = [x["id"] for x in page['properties']['ÈòÖËØªÊó•']["relation"]]
            episode['ÈòÖËØªÊó•'].extend(oldReadDays)
            delta_listen_time = int(episode['ÈòÖËØªÊó∂Èïø']) - int(page['properties']['ÈòÖËØªÊó∂Èïø']['number'])

        properties = utils.get_properties(episode, book_properties_type_dict)
        print(
            f"Ê≠£Âú®ÂêåÊ≠• = {result.get('title')}ÔºåÊú¨Ê¨°Êî∂Âê¨{delta_listen_time}ÁßíÔºåÂÖ±{len(episodes)}‰∏™EpisodeÔºåÂΩìÂâçÊòØÁ¨¨{index+1}‰∏™"
        )
        parent = {
            "database_id": notion_helper.episode_database_id,
            "type": "database_id",
        }

        if page:
            page_id = page['id']
            notion_helper.update_page(page_id=page_id, properties=properties)
        else:
            notion_helper.create_page(
                parent=parent, properties=properties, icon=get_icon(d.get(pid)[1])
            )

if __name__ == "__main__":
    current_time = datetime.now()
    print("ÂºÄÂßãÂêåÊ≠•Êí≠ÂÆ¢ÔºåÂΩìÂâçÊó∂Èó¥: ", current_time)
    notion_helper = NotionHelper()
    refresh_token()

    d = insert_podcast()
    episodes = get_history()
    eids = [x.get("eid") for x in episodes]
    progress = get_progress(eids)
    progress = {x.get("eid"): x for x in progress}
    print("ÈòÖËØªËøõÂ∫¶------")
    print(json.dumps(progress))
    for episode in episodes:
        if episode["eid"] in progress:
            playAt = progress.get(episode["eid"]).get("playedAt")
            playAtBeijingTime = pendulum.parse(playAt).in_tz('Asia/Shanghai')
            playAtDay = playAtBeijingTime.format("YYYY-MM-DD")
            episode["ÈòÖËØªÊó•"] = [playAtDay]
            episode["ÈòÖËØªÊó∂Èïø"] = progress.get(episode["eid"]).get("progress")
        else:
            episode["ÈòÖËØªÊó∂Èïø"] = 0
    insert_episode(episodes, d)
    # ÊµãËØï
    #ËøôÈáå‰ºöËØØÂà†"ÊÉ≥Áúã"Áä∂ÊÄÅÁöÑÊñáÁåÆÁ¨îËÆ∞
    #delete()
